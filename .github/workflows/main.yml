name: Arthaone Multi-Env Security Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: arthaonecoreapi
  DOTNET_SOLUTION_PATH: ./ArthaAPI/Core.API.csproj  # Change this to the actual folder path
  TRIVY_REPORT_DIR: ./TrivyReport
  DEPENDENCY_REPORT_DIR: ./DependencyCheck

jobs:
  # --- CI BUILD & SCAN STAGE ---
  build_and_scan:
    name: CI Build + Security Scanning
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Removed 'Setup .NET' to avoid permission errors on self-hosted runner

      - name: SonarQube Analysis
        run: |
          echo "Starting SonarQube Analysis..."

      - name: Dotnet Build
        run: dotnet build ${{ env.DOTNET_SOLUTION_PATH }} --configuration Release

  # --- TST ENVIRONMENT DEPLOYMENT ---
  deploy-tst:
    name: Deploy to TST
    needs: build_and_scan
    environment: TST
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build & Push Docker to TST ACR
        run: |
          echo "Building Docker for TST..."
          docker build -t tstarthaoneacr.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ github.run_id }} -f core-Dockerfile .

      - name: Trivy Image Scan
        run: |
          trivy image --severity HIGH,CRITICAL tstarthaoneacr.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ github.run_id }} || echo "Vulnerabilities found"

  # --- STG ENVIRONMENT DEPLOYMENT ---
  deploy-stg:
    name: Deploy to STG
    needs: deploy-tst
    environment: STG
    runs-on: self-hosted
    steps:
      - name: STG Specific Logic
        run: echo "Promoting to STG..."

  # --- PRD ENVIRONMENT DEPLOYMENT ---
  deploy-prd:
    name: Deploy to PRD
    needs: deploy-stg
    environment: PRD
    runs-on: self-hosted
    steps:
      - name: PRD Specific Logic
        run: echo "Deploying to Production Server..."
