name: Arthaone Node.js Multi-Env Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: arthaonecoreapi

jobs:
  # --- BUILD STAGE ---
  build:
    name: Build & Scan
    runs-on: [self-hosted, Windows, X64]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: npm install

      - name: Build
        run: npm run build --if-present

  # --- TST ENVIRONMENT ---
  deploy-tst:
    name: Deploy to TST
    needs: build
    environment: TST
    runs-on: [self-hosted, Windows, X64]
    steps:
      - name: Docker Build
        run: docker build -t tstarthaoneacr.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ github.run_id }} .

  # --- STG ENVIRONMENT ---
  deploy-stg:
    name: Deploy to STG
    needs: deploy-tst
    environment: STG
    runs-on: [self-hosted, Windows, X64]
    steps:
      - name: Staging Deploy
        run: echo "Deploying to STG..."

  # --- PRD ENVIRONMENT ---
  deploy-prd:
    name: Deploy to PRD
    needs: deploy-stg
    environment: PRD
    runs-on: [self-hosted, Windows, X64]
    steps:
      - name: Production Deploy
        run: echo "Deploying to PRD..."
